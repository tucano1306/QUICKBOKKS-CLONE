generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String               @id @default(cuid())
  name                String?
  email               String               @unique
  emailVerified       DateTime?
  password            String
  image               String?
  role                UserRole             @default(USER)
  company             String?
  phone               String?
  address             String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  accounts            Account[]
  bankAccounts        BankAccount[]
  companyMemberships  CompanyUser[]
  employees           Employee[]
  expenses            Expense[]
  invoices            Invoice[]
  reconciliationRules ReconciliationRule[]
  sessions            Session[]
  taxReturns          TaxReturn[]
  uploadedDocuments   UploadedDocument[]
  firmStaff           FirmStaff[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Customer {
  id              String         @id @default(cuid())
  name            String
  email           String?
  phone           String?
  company         String?
  taxId           String?
  address         String?
  city            String?
  state           String?
  zipCode         String?
  country         String         @default("México")
  notes           String?
  status          CustomerStatus @default(ACTIVE)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  portalActive    Boolean        @default(false)
  portalLastLogin DateTime?
  portalPassword  String?
  companyId       String?
  invoices        Invoice[]
  transactions    Transaction[]

  @@map("customers")
}

model Vendor {
  id             String        @id @default(cuid())
  companyId      String?
  vendorNumber   String        @unique
  name           String
  contactName    String?
  email          String?
  phone          String?
  address        String?
  city           String?
  state          String?
  country        String?       @default("México")
  taxId          String?
  paymentTerms   String?       @default("Net 30")
  category       String?
  status         VendorStatus  @default(ACTIVE)
  totalPurchases Float         @default(0)
  currentBalance Float         @default(0)
  notes          String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  payables       VendorPayable[]
  documents      UploadedDocument[]

  @@map("vendors")
}

model VendorPayable {
  id           String         @id @default(cuid())
  companyId    String?
  vendorId     String
  billNumber   String
  description  String?
  category     String?
  terms        String?
  reference    String?
  issueDate    DateTime
  dueDate      DateTime
  subtotal     Float          @default(0)
  taxAmount    Float          @default(0)
  total        Float
  paidAmount   Float          @default(0)
  balance      Float          @default(0)
  status       PayableStatus  @default(UNPAID)
  attachments  String[]       @default([])
  notes        String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  vendor       Vendor         @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([vendorId])
  @@index([status])
  @@unique([companyId, billNumber])
  @@map("vendor_payables")
}

model Product {
  id           String                @id @default(cuid())
  name         String
  description  String?
  type         ProductType           @default(SERVICE)
  sku          String?               @unique
  price        Float
  cost         Float?
  taxable      Boolean               @default(true)
  taxRate      Float                 @default(16)
  category     String?
  unit         String?
  status       ProductStatus         @default(ACTIVE)
  stock        Int?                  @default(0)
  reorderLevel Int?
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt
  companyId    String?
  adjustments  InventoryAdjustment[]
  valuations   InventoryValuation[]
  invoiceItems InvoiceItem[]

  @@map("products")
}

model Invoice {
  id               String            @id @default(cuid())
  invoiceNumber    String            @unique
  customerId       String
  userId           String
  issueDate        DateTime          @default(now())
  dueDate          DateTime
  subtotal         Float
  taxAmount        Float
  discount         Float             @default(0)
  total            Float
  status           InvoiceStatus     @default(DRAFT)
  notes            String?
  terms            String?
  paymentMethod    PaymentMethod?
  paidDate         DateTime?
  currencyId       String?
  exchangeRate     Float             @default(1)
  costCenterId     String?
  projectId        String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  billToAddress    String?
  poNumber         String?
  salesTaxRate     Float             @default(0)
  shipToAddress    String?
  taxExempt        Boolean           @default(false)
  taxExemptReason  String?
  paymentTerms     String?
  companyId        String?
  paymentLinkId    String?           @unique
  paymentLinkUrl   String?
  paymentLinkExpiry DateTime?
  paymentLinkActive Boolean          @default(false)
  paymentGateway   String?
  paymentGatewayId String?
  bankTransactions BankTransaction[]
  creditNotes      CreditNote[]
  eInvoice         EInvoice?
  items            InvoiceItem[]
  company          Company?          @relation(fields: [companyId], references: [id])
  currency         Currency?         @relation(fields: [currencyId], references: [id])
  customer         Customer          @relation(fields: [customerId], references: [id])
  project          Project?          @relation(fields: [projectId], references: [id])
  user             User              @relation(fields: [userId], references: [id])
  reminders        PaymentReminder[]
  payments         Payment[]
  withholdings     TaxWithholding[]

  @@index([companyId])
  @@map("invoices")
}

model InvoiceItem {
  id          String  @id @default(cuid())
  invoiceId   String
  productId   String
  description String
  quantity    Float
  unitPrice   Float
  taxRate     Float
  taxAmount   Float
  total       Float
  companyId   String?
  invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product     Product @relation(fields: [productId], references: [id])

  @@map("invoice_items")
}

model Payment {
  id               String            @id @default(cuid())
  invoiceId        String
  amount           Float
  paymentDate      DateTime          @default(now())
  paymentMethod    PaymentMethod
  reference        String?
  notes            String?
  createdAt        DateTime          @default(now())
  companyId        String?
  bankTransactions BankTransaction[]
  invoice          Invoice           @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model Expense {
  id               String            @id @default(cuid())
  userId           String
  categoryId       String
  amount           Float
  date             DateTime          @default(now())
  description      String
  vendor           String?
  paymentMethod    PaymentMethod
  reference        String?
  taxDeductible    Boolean           @default(true)
  taxAmount        Float             @default(0)
  notes            String?
  attachments      String[]
  status           ExpenseStatus     @default(PENDING)
  costCenterId     String?
  projectId        String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  employeeId       String?
  companyId        String?
  bankTransactions BankTransaction[]
  category         ExpenseCategory   @relation(fields: [categoryId], references: [id])
  company          Company?          @relation(fields: [companyId], references: [id])
  costCenter       CostCenter?       @relation(fields: [costCenterId], references: [id])
  employee         Employee?         @relation(fields: [employeeId], references: [id])
  project          Project?          @relation(fields: [projectId], references: [id])
  user             User              @relation(fields: [userId], references: [id])
  withholdings     TaxWithholding[]

  @@index([companyId])
  @@map("expenses")
}

model ExpenseCategory {
  id          String            @id @default(cuid())
  name        String
  description String?
  type        ExpenseType
  taxRate     Float             @default(16)
  parentId    String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  companyId   String?
  parent      ExpenseCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    ExpenseCategory[] @relation("CategoryHierarchy")
  expenses    Expense[]

  @@map("expense_categories")
}

model Transaction {
  id          String            @id @default(cuid())
  customerId  String?
  type        TransactionType
  category    String
  amount      Float
  date        DateTime          @default(now())
  description String
  reference   String?
  status      TransactionStatus @default(COMPLETED)
  notes       String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  companyId   String?
  customer    Customer?         @relation(fields: [customerId], references: [id])

  @@map("transactions")
}

model Employee {
  id              String           @id @default(cuid())
  userId          String
  employeeNumber  String           @unique
  firstName       String
  lastName        String
  email           String           @unique
  phone           String?
  position        String
  department      String?
  hireDate        DateTime
  terminationDate DateTime?
  salary          Float
  salaryType      SalaryType       @default(MONTHLY)
  taxId           String?
  bankAccount     String?
  address         String?
  status          EmployeeStatus   @default(ACTIVE)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  employeeType    String           @default("EMPLOYEE")
  companyId       String?
  user            User             @relation(fields: [userId], references: [id])
  expenses        Expense[]
  payrolls        Payroll[]
  timeEntries     TimeEntry[]
  checks          PayrollCheck[]
  payments        PayrollPayment[]
  runItems        PayrollRunItem[]

  @@map("employees")
}

model Payroll {
  id             String             @id @default(cuid())
  employeeId     String
  periodStart    DateTime
  periodEnd      DateTime
  grossSalary    Float
  deductions     Float
  bonuses        Float              @default(0)
  netSalary      Float
  paymentDate    DateTime?
  checkNumber    String?
  checkDate      DateTime?
  paymentMethod  String             @default("Check")
  status         PayrollStatus      @default(DRAFT)
  notes          String?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  companyId      String?
  deductionItems PayrollDeduction[]
  employee       Employee           @relation(fields: [employeeId], references: [id])
  checks         PayrollCheck[]
  payments       PayrollPayment[]

  @@map("payrolls")
}

model PayrollDeduction {
  id          String  @id @default(cuid())
  payrollId   String
  type        String
  description String
  amount      Float
  companyId   String?
  payroll     Payroll @relation(fields: [payrollId], references: [id], onDelete: Cascade)

  @@map("payroll_deductions")
}

model TaxReturn {
  id             String    @id @default(cuid())
  userId         String
  taxType        TaxType
  period         String
  year           Int
  startDate      DateTime?
  endDate        DateTime?
  amount         Float
  totalSales     Float     @default(0)
  totalPurchases Float     @default(0)
  taxCollected   Float     @default(0)
  taxPaid        Float     @default(0)
  taxDue         Float     @default(0)
  status         TaxStatus @default(PENDING)
  dueDate        DateTime
  filedDate      DateTime?
  notes          String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  companyId      String?
  user           User      @relation(fields: [userId], references: [id])

  @@map("tax_returns")
}

model TaxConfig {
  id          String   @id @default(cuid())
  name        String
  type        TaxType
  rate        Float
  description String?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  companyId   String?

  @@map("tax_config")
}

model BankAccount {
  id               String               @id @default(cuid())
  userId           String
  accountName      String
  accountNumber    String?
  bankName         String?
  accountType      BankAccountType      @default(CHECKING)
  currency         String               @default("USD")
  balance          Float                @default(0)
  lastReconciled   DateTime?
  status           BankAccountStatus    @default(ACTIVE)
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  accountSubtype   String?
  autoSync         Boolean              @default(true)
  availableBalance Float?
  institutionId    String?
  institutionName  String?
  isActive         Boolean              @default(true)
  isPrimary        Boolean              @default(false)
  lastSyncedAt     DateTime?
  mask             String?
  notes            String?
  plaidAccessToken String?
  plaidAccountId   String?              @unique
  plaidItemId      String?
  syncFrequency    Int                  @default(24)
  companyId        String?
  user             User                 @relation(fields: [userId], references: [id])
  reconciliations  BankReconciliation[]
  bankTransactions BankTransaction[]
  rules            ReconciliationRule[]

  @@index([userId])
  @@index([plaidItemId])
  @@map("bank_accounts")
}

model BankTransaction {
  id                 String                @id @default(cuid())
  bankAccountId      String
  date               DateTime
  description        String?
  reference          String?
  debit              Float                 @default(0)
  credit             Float                 @default(0)
  balance            Float                 @default(0)
  reconciled         Boolean               @default(false)
  notes              String?
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  amount             Float
  authorizedDate     DateTime?
  categoryId         String?
  isoCurrencyCode    String                @default("USD")
  location           Json?
  matchedExpenseId   String?
  matchedInvoiceId   String?
  matchedPaymentId   String?
  merchantName       String?
  name               String
  paymentChannel     String?
  paymentMeta        Json?
  pending            Boolean               @default(false)
  plaidTransactionId String?               @unique
  reconciledAt       DateTime?
  reconciledBy       String?
  transactionCode    String?
  category           String[]
  companyId          String?
  bankAccount        BankAccount           @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)
  expense            Expense?              @relation(fields: [matchedExpenseId], references: [id])
  invoice            Invoice?              @relation(fields: [matchedInvoiceId], references: [id])
  payment            Payment?              @relation(fields: [matchedPaymentId], references: [id])
  matches            ReconciliationMatch[]

  @@index([bankAccountId])
  @@index([date])
  @@index([reconciled])
  @@map("bank_transactions")
}

model BankReconciliation {
  id             String                @id @default(cuid())
  bankAccountId  String
  startDate      DateTime
  endDate        DateTime
  openingBalance Float
  closingBalance Float
  reconciledBy   String?
  status         ReconciliationStatus  @default(IN_PROGRESS)
  notes          String?
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  companyId      String?
  bankAccount    BankAccount           @relation(fields: [bankAccountId], references: [id])
  matches        ReconciliationMatch[]

  @@index([bankAccountId])
  @@map("bank_reconciliations")
}

model ReconciliationRule {
  id            String       @id @default(cuid())
  bankAccountId String?
  userId        String
  name          String
  description   String?
  priority      Int          @default(0)
  isActive      Boolean      @default(true)
  conditions    Json
  categoryId    String?
  accountId     String?
  autoMatch     Boolean      @default(false)
  addTags       String[]
  timesApplied  Int          @default(0)
  lastAppliedAt DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  companyId     String?
  bankAccount   BankAccount? @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)
  user          User         @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([bankAccountId])
  @@map("reconciliation_rules")
}

model ReconciliationMatch {
  id                String             @id @default(cuid())
  reconciliationId  String
  bankTransactionId String
  transactionType   String
  transactionId     String?
  matchType         MatchType          @default(MANUAL)
  createdAt         DateTime           @default(now())
  amountDifference  Float              @default(0)
  confidence        Float              @default(0)
  confirmedAt       DateTime?
  confirmedBy       String?
  dateDifference    Int                @default(0)
  isConfirmed       Boolean            @default(false)
  updatedAt         DateTime           @updatedAt
  companyId         String?
  bankTransaction   BankTransaction    @relation(fields: [bankTransactionId], references: [id])
  reconciliation    BankReconciliation @relation(fields: [reconciliationId], references: [id], onDelete: Cascade)

  @@index([reconciliationId])
  @@index([bankTransactionId])
  @@map("reconciliation_matches")
}

model ChartOfAccounts {
  id                  String             @id @default(cuid())
  code                String             @unique
  name                String
  type                AccountType
  category            AccountCategory?
  parentId            String?
  level               Int                @default(1)
  isActive            Boolean            @default(true)
  description         String?
  balance             Float              @default(0)
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  companyId           String?
  budgets             Budget[]
  parent              ChartOfAccounts?   @relation("AccountHierarchy", fields: [parentId], references: [id])
  children            ChartOfAccounts[]  @relation("AccountHierarchy")
  journalEntries      JournalEntryLine[]
  suggestedDocuments  UploadedDocument[]
  categorizationRules AiCategorizationRule[]

  @@map("chart_of_accounts")
}

model JournalEntry {
  id           String             @id @default(cuid())
  entryNumber  String             @unique
  date         DateTime
  description  String
  reference    String?
  status       JournalEntryStatus @default(DRAFT)
  isReversed   Boolean            @default(false)
  reversedById String?
  costCenterId String?
  createdBy    String
  approvedBy   String?
  approvedAt   DateTime?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  companyId    String?
  company      Company?           @relation(fields: [companyId], references: [id])
  costCenter   CostCenter?        @relation(fields: [costCenterId], references: [id])
  reversedBy   JournalEntry?      @relation("ReversedEntries", fields: [reversedById], references: [id])
  reversals    JournalEntry[]     @relation("ReversedEntries")
  lines        JournalEntryLine[]
  documents    UploadedDocument[]

  @@index([companyId])
  @@map("journal_entries")
}

model JournalEntryLine {
  id             String          @id @default(cuid())
  journalEntryId String
  accountId      String
  description    String?
  debit          Float           @default(0)
  credit         Float           @default(0)
  currencyId     String?
  exchangeRate   Float?
  lineNumber     Int
  createdAt      DateTime        @default(now())
  companyId      String?
  account        ChartOfAccounts @relation(fields: [accountId], references: [id])
  currency       Currency?       @relation(fields: [currencyId], references: [id])
  journalEntry   JournalEntry    @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)

  @@map("journal_entry_lines")
}

model Budget {
  id           String          @id @default(cuid())
  name         String
  fiscalYear   Int
  startDate    DateTime
  endDate      DateTime
  accountId    String
  costCenterId String?
  amount       Float
  spent        Float           @default(0)
  remaining    Float           @default(0)
  status       BudgetStatus    @default(ACTIVE)
  notes        String?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  companyId    String?
  periods      BudgetPeriod[]
  account      ChartOfAccounts @relation(fields: [accountId], references: [id])
  costCenter   CostCenter?     @relation(fields: [costCenterId], references: [id])

  @@map("budgets")
}

model BudgetPeriod {
  id              String   @id @default(cuid())
  budgetId        String
  period          String
  startDate       DateTime
  endDate         DateTime
  budgetAmount    Float
  actualAmount    Float    @default(0)
  variance        Float    @default(0)
  variancePercent Float    @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  companyId       String?
  budget          Budget   @relation(fields: [budgetId], references: [id], onDelete: Cascade)

  @@map("budget_periods")
}

model Asset {
  id                      String              @id @default(cuid())
  assetNumber             String              @unique
  name                    String
  description             String?
  category                AssetCategory
  purchaseDate            DateTime
  purchasePrice           Float
  salvageValue            Float               @default(0)
  usefulLife              Int
  depreciationMethod      DepreciationMethod  @default(STRAIGHT_LINE)
  accountId               String?
  locationId              String?
  costCenterId            String?
  status                  AssetStatus         @default(ACTIVE)
  accumulatedDepreciation Float               @default(0)
  bookValue               Float
  disposalDate            DateTime?
  disposalPrice           Float?
  disposalMethod          String?
  notes                   String?
  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt
  companyId               String?
  depreciations           AssetDepreciation[]
  costCenter              CostCenter?         @relation(fields: [costCenterId], references: [id])

  @@map("assets")
}

model AssetDepreciation {
  id                      String   @id @default(cuid())
  assetId                 String
  period                  DateTime
  depreciationAmount      Float
  accumulatedDepreciation Float
  bookValue               Float
  notes                   String?
  createdAt               DateTime @default(now())
  companyId               String?
  asset                   Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@map("asset_depreciations")
}

model Currency {
  id             String             @id @default(cuid())
  code           String             @unique
  name           String
  symbol         String
  exchangeRate   Float              @default(1)
  isBaseCurrency Boolean            @default(false)
  isActive       Boolean            @default(true)
  decimalPlaces  Int                @default(2)
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  companyId      String?
  exchangeRates  ExchangeRate[]
  invoices       Invoice[]
  journalLines   JournalEntryLine[]

  @@map("currencies")
}

model ExchangeRate {
  id         String   @id @default(cuid())
  currencyId String
  date       DateTime
  rate       Float
  source     String?
  createdAt  DateTime @default(now())
  companyId  String?
  currency   Currency @relation(fields: [currencyId], references: [id], onDelete: Cascade)

  @@unique([currencyId, date])
  @@map("exchange_rates")
}

model CostCenter {
  id             String         @id @default(cuid())
  code           String         @unique
  name           String
  description    String?
  parentId       String?
  isActive       Boolean        @default(true)
  managerId      String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  companyId      String?
  assets         Asset[]
  budgets        Budget[]
  parent         CostCenter?    @relation("CostCenterHierarchy", fields: [parentId], references: [id])
  children       CostCenter[]   @relation("CostCenterHierarchy")
  expenses       Expense[]
  journalEntries JournalEntry[]
  projects       Project[]

  @@map("cost_centers")
}

model Project {
  id            String        @id @default(cuid())
  code          String?
  name          String
  description   String?
  status        ProjectStatus @default(PLANNING)
  priority      String?       @default("MEDIUM")
  startDate     DateTime?
  endDate       DateTime?
  budget        Float         @default(0)
  actualCost    Float         @default(0)
  revenue       Float         @default(0)
  progress      Int           @default(0)
  managerId     String?
  customerId    String?
  costCenterId  String?
  companyId     String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  costCenter    CostCenter?   @relation(fields: [costCenterId], references: [id])
  expenses      Expense[]
  invoices      Invoice[]
  tasks         ProjectTask[]
  timeEntries   TimeEntry[]

  @@map("projects")
}

model ProjectTask {
  id          String      @id @default(cuid())
  projectId   String
  name        String
  description String?
  status      String      @default("PENDING")
  priority    String?     @default("MEDIUM")
  assigneeId  String?
  dueDate     DateTime?
  estimatedHours Float?
  actualHours Float?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  project     Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("project_tasks")
}

enum ProjectStatus {
  PLANNING
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

model TaxWithholding {
  id                String   @id @default(cuid())
  invoiceId         String?
  expenseId         String?
  withholdingType   String
  taxBase           Float
  percentage        Float
  amount            Float
  certificateNumber String?
  date              DateTime
  createdAt         DateTime @default(now())
  companyId         String?
  expense           Expense? @relation(fields: [expenseId], references: [id])
  invoice           Invoice? @relation(fields: [invoiceId], references: [id])

  @@map("tax_withholdings")
}

model InventoryValuation {
  id        String          @id @default(cuid())
  productId String
  method    ValuationMethod @default(AVERAGE)
  quantity  Int
  unitCost  Float
  totalCost Float
  date      DateTime
  createdAt DateTime        @default(now())
  companyId String?
  product   Product         @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("inventory_valuations")
}

model InventoryAdjustment {
  id             String         @id @default(cuid())
  productId      String
  adjustmentType AdjustmentType
  quantity       Int
  costImpact     Float          @default(0)
  reason         String
  notes          String?
  date           DateTime
  createdAt      DateTime       @default(now())
  companyId      String?
  product        Product        @relation(fields: [productId], references: [id])

  @@map("inventory_adjustments")
}

model AgingReport {
  id             String   @id @default(cuid())
  entityType     String
  entityId       String
  documentType   String
  documentNumber String
  documentDate   DateTime
  dueDate        DateTime
  amount         Float
  balance        Float
  daysOverdue    Int
  agingBucket    String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  companyId      String?

  @@map("aging_reports")
}

model PaymentReminder {
  id             String         @id @default(cuid())
  invoiceId      String
  reminderNumber Int
  sentDate       DateTime
  dueDate        DateTime
  amount         Float
  status         ReminderStatus @default(PENDING)
  emailSent      Boolean        @default(false)
  notes          String?
  createdAt      DateTime       @default(now())
  companyId      String?
  invoice        Invoice        @relation(fields: [invoiceId], references: [id])

  @@map("payment_reminders")
}

model CreditNote {
  id         String   @id @default(cuid())
  noteNumber String   @unique
  invoiceId  String
  date       DateTime
  amount     Float
  reason     String
  status     String   @default("ISSUED")
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  companyId  String?
  invoice    Invoice  @relation(fields: [invoiceId], references: [id])

  @@map("credit_notes")
}

model FinancialStatement {
  id            String        @id @default(cuid())
  statementType StatementType
  period        String
  startDate     DateTime
  endDate       DateTime
  data          Json
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  companyId     String?

  @@map("financial_statements")
}

model CashFlowProjection {
  id               String   @id @default(cuid())
  period           DateTime
  projectedIncome  Float
  projectedExpense Float
  projectedBalance Float
  actualIncome     Float?
  actualExpense    Float?
  actualBalance    Float?
  variance         Float?
  notes            String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  companyId        String?

  @@map("cash_flow_projections")
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  action     String
  entityType String
  entityId   String?
  changes    Json?
  ipAddress  String?
  userAgent  String?
  timestamp  DateTime @default(now())
  companyId  String?

  @@index([userId])
  @@index([entityType])
  @@index([timestamp])
  @@map("audit_logs")
}

model Permission {
  id          String           @id @default(cuid())
  name        String?          @unique
  description String?
  createdAt   DateTime         @default(now())
  category    String?
  resource    String
  action      PermissionAction
  roles       RolePermission[]

  @@unique([resource, action])
  @@map("permissions")
}

model Role {
  id          String              @id @default(cuid())
  name        String
  description String?
  isSystem    Boolean             @default(false)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  companyId   String?
  permissions RolePermission[]
  userRoles   UserRole_Advanced[]

  @@unique([name, companyId])
  @@map("roles")
}

model RolePermission {
  id           String     @id @default(cuid())
  roleId       String
  permissionId String
  canCreate    Boolean    @default(false)
  canDelete    Boolean    @default(false)
  canRead      Boolean    @default(false)
  canUpdate    Boolean    @default(false)
  conditions   Json?
  createdAt    DateTime   @default(now())
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

model UserRole_Advanced {
  id        String   @id @default(cuid())
  userId    String
  roleId    String
  grantedBy String?
  grantedAt DateTime @default(now())
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@map("user_roles")
}

model EncryptedData {
  id         String   @id @default(cuid())
  entityType String
  entityId   String
  fieldName  String
  encrypted  String
  iv         String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([entityType, entityId, fieldName])
  @@map("encrypted_data")
}

model SystemConfig {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  category  String
  encrypted Boolean  @default(false)
  updatedBy String?
  updatedAt DateTime @updatedAt

  @@map("system_config")
}

model LoginAttempt {
  id         String   @id @default(cuid())
  email      String
  success    Boolean
  ipAddress  String?
  userAgent  String?
  failReason String?
  timestamp  DateTime @default(now())

  @@index([email])
  @@index([timestamp])
  @@map("login_attempts")
}

model ApiKey {
  id          String         @id @default(cuid())
  name        String
  key         String         @unique
  userId      String?
  permissions Json?
  expiresAt   DateTime?
  isActive    Boolean        @default(true)
  createdAt   DateTime       @default(now())
  companyId   String
  createdBy   String?
  environment ApiEnvironment @default(PRODUCTION)
  lastUsedAt  DateTime?
  prefix      String
  scopes      String[]
  updatedAt   DateTime       @default(now()) @updatedAt
  company     Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  logs        ApiLog[]

  @@index([userId])
  @@index([companyId])
  @@map("api_keys")
}

model EInvoice {
  id                   String         @id @default(cuid())
  invoiceId            String         @unique
  invoiceNumber        String         @unique
  companyName          String
  companyEIN           String
  companyAddress       String
  companyCity          String
  companyState         String         @default("FL")
  companyZip           String
  companyPhone         String?
  companyEmail         String?
  customerName         String
  customerTaxId        String?
  customerAddress      String
  customerCity         String
  customerState        String
  customerZip          String
  customerEmail        String?
  issueDate            DateTime
  dueDate              DateTime?
  poNumber             String?
  subtotal             Float
  discountAmount       Float          @default(0)
  taxableAmount        Float
  salesTaxRate         Float          @default(0)
  salesTaxAmount       Float          @default(0)
  totalAmount          Float
  floridaSalesTax      Boolean        @default(true)
  countyTax            Float?
  discretionaryTax     Float?
  taxExempt            Boolean        @default(false)
  exemptionCertificate String?
  paymentTerms         String?
  paymentMethod        String?
  status               EInvoiceStatus @default(DRAFT)
  sentDate             DateTime?
  paidDate             DateTime?
  voidDate             DateTime?
  voidReason           String?
  pdfPath              String?
  pdfContent           String?
  irsSent              Boolean        @default(false)
  form1099Required     Boolean        @default(false)
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  companyId            String?
  invoice              Invoice        @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceNumber])
  @@index([companyEIN])
  @@index([customerTaxId])
  @@index([issueDate])
  @@map("e_invoices")
}

model SalesTaxRate {
  id             String    @id @default(cuid())
  state          String
  county         String?
  city           String?
  zipCode        String?
  stateTaxRate   Float
  countyTaxRate  Float     @default(0)
  cityTaxRate    Float     @default(0)
  specialTaxRate Float     @default(0)
  totalTaxRate   Float
  effectiveDate  DateTime
  endDate        DateTime?
  isActive       Boolean   @default(true)
  description    String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  companyId      String?

  @@unique([state, county, city, zipCode, effectiveDate])
  @@index([zipCode])
  @@map("sales_tax_rates")
}

model TaxExemption {
  id                String    @id @default(cuid())
  customerId        String
  certificateNumber String    @unique
  certificateType   String
  issuingState      String
  expirationDate    DateTime?
  certificatePath   String?
  certificateFile   String?
  isActive          Boolean   @default(true)
  notes             String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  companyId         String?

  @@index([customerId])
  @@map("tax_exemptions")
}

model Form1099 {
  id            String    @id @default(cuid())
  year          Int
  vendorId      String
  vendorName    String
  vendorTaxId   String
  vendorAddress String
  formType      String
  box1Amount    Float     @default(0)
  box2Amount    Float     @default(0)
  box3Amount    Float     @default(0)
  box4Amount    Float     @default(0)
  box7Amount    Float     @default(0)
  totalAmount   Float
  filed         Boolean   @default(false)
  filedDate     DateTime?
  eFileStatus   String?
  pdfPath       String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([year, vendorId, formType])
  @@index([year])
  @@index([vendorTaxId])
  @@map("form_1099")
}

model W9Form {
  id                String    @id @default(cuid())
  vendorId          String    @unique
  vendorName        String
  businessName      String?
  taxClassification String
  ein               String?
  ssn               String?
  address           String
  city              String
  state             String
  zipCode           String
  exemptPayeeCode   String?
  exemptFATCA       Boolean   @default(false)
  signedDate        DateTime?
  signaturePath     String?
  w9FilePath        String?
  w9FileContent     String?
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@map("w9_forms")
}

model Warehouse {
  id             String          @id @default(cuid())
  userId         String
  name           String
  code           String          @unique
  description    String?
  address        String
  city           String
  state          String
  zipCode        String
  country        String          @default("US")
  phone          String?
  email          String?
  manager        String?
  isActive       Boolean         @default(true)
  isPrimary      Boolean         @default(false)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  inventoryItems InventoryItem[]
  stockMovements StockMovement[]

  @@index([userId])
  @@map("warehouses")
}

model InventoryItem {
  id                 String              @id @default(cuid())
  userId             String
  warehouseId        String
  sku                String              @unique
  name               String
  description        String?
  category           String?
  itemType           ItemType            @default(PRODUCT)
  unit               String              @default("pcs")
  quantity           Float               @default(0)
  minStock           Float               @default(0)
  maxStock           Float?
  trackBatches       Boolean             @default(false)
  trackSerial        Boolean             @default(false)
  costMethod         CostMethod          @default(AVERAGE)
  unitCost           Float               @default(0)
  avgCost            Float               @default(0)
  salePrice          Float?
  isActive           Boolean             @default(true)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  batches            Batch[]
  warehouse          Warehouse           @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  purchaseOrderItems PurchaseOrderItem[]
  serialNumbers      SerialNumber[]
  stockAlerts        StockAlert[]
  stockMovements     StockMovement[]

  @@index([userId])
  @@index([warehouseId])
  @@index([sku])
  @@map("inventory_items")
}

model Batch {
  id               String          @id @default(cuid())
  inventoryItemId  String
  batchNumber      String
  quantity         Float
  unitCost         Float
  manufacturedDate DateTime?
  expirationDate   DateTime?
  receivedDate     DateTime        @default(now())
  isActive         Boolean         @default(true)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  inventoryItem    InventoryItem   @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)
  stockMovements   StockMovement[]

  @@unique([inventoryItemId, batchNumber])
  @@index([inventoryItemId])
  @@index([expirationDate])
  @@map("batches")
}

model SerialNumber {
  id              String          @id @default(cuid())
  inventoryItemId String
  serialNumber    String          @unique
  status          SerialStatus    @default(IN_STOCK)
  unitCost        Float
  receivedDate    DateTime        @default(now())
  soldDate        DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  inventoryItem   InventoryItem   @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)
  stockMovements  StockMovement[]

  @@index([inventoryItemId])
  @@index([status])
  @@map("serial_numbers")
}

model StockMovement {
  id              String        @id @default(cuid())
  userId          String
  inventoryItemId String
  warehouseId     String
  batchId         String?
  serialNumberId  String?
  movementType    MovementType
  quantity        Float
  unitCost        Float
  totalCost       Float
  referenceType   String?
  referenceId     String?
  description     String?
  notes           String?
  movementDate    DateTime      @default(now())
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  batch           Batch?        @relation(fields: [batchId], references: [id])
  inventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)
  serialNumber    SerialNumber? @relation(fields: [serialNumberId], references: [id])
  warehouse       Warehouse     @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([inventoryItemId])
  @@index([warehouseId])
  @@index([movementType])
  @@index([movementDate])
  @@map("stock_movements")
}

model PurchaseOrder {
  id           String              @id @default(cuid())
  userId       String
  poNumber     String              @unique
  vendorId     String?
  vendorName   String
  vendorEmail  String?
  vendorPhone  String?
  orderDate    DateTime            @default(now())
  expectedDate DateTime?
  receivedDate DateTime?
  status       POStatus            @default(DRAFT)
  subtotal     Float               @default(0)
  tax          Float               @default(0)
  shipping     Float               @default(0)
  total        Float               @default(0)
  notes        String?
  terms        String?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  items        PurchaseOrderItem[]

  @@index([userId])
  @@index([status])
  @@index([orderDate])
  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id              String        @id @default(cuid())
  purchaseOrderId String
  inventoryItemId String
  description     String
  quantity        Float
  unitCost        Float
  totalCost       Float
  receivedQty     Float         @default(0)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  inventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id])
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  @@index([purchaseOrderId])
  @@index([inventoryItemId])
  @@map("purchase_order_items")
}

model StockAlert {
  id              String        @id @default(cuid())
  inventoryItemId String
  userId          String
  alertType       AlertType
  threshold       Float?
  isActive        Boolean       @default(true)
  isResolved      Boolean       @default(false)
  notified        Boolean       @default(false)
  notifiedAt      DateTime?
  resolvedAt      DateTime?
  resolvedBy      String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  inventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)

  @@index([inventoryItemId])
  @@index([userId])
  @@index([isResolved])
  @@index([alertType])
  @@map("stock_alerts")
}

model TaxForm1099 {
  id               String        @id @default(cuid())
  userId           String
  payerName        String
  payerEIN         String
  payerAddress     String
  payerCity        String
  payerState       String
  payerZip         String
  recipientName    String
  recipientTIN     String
  recipientAddress String
  recipientCity    String
  recipientState   String
  recipientZip     String
  recipientEmail   String?
  formType         Form1099Type
  taxYear          Int
  box1Amount       Float         @default(0)
  box2Amount       Float         @default(0)
  box3Amount       Float         @default(0)
  box4Amount       Float         @default(0)
  box5Amount       Float         @default(0)
  box6Amount       Float         @default(0)
  box7Amount       Float         @default(0)
  box8Amount       Float         @default(0)
  box10Amount      Float         @default(0)
  status           Tax1099Status @default(DRAFT)
  filingRequired   Boolean       @default(true)
  filedDate        DateTime?
  correctionOf     String?
  isCorrection     Boolean       @default(false)
  generatedAt      DateTime      @default(now())
  sentToRecipient  Boolean       @default(false)
  sentDate         DateTime?
  filedWithIRS     Boolean       @default(false)
  irsFiledDate     DateTime?
  expenseIds       String[]
  invoiceIds       String[]
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  @@index([userId])
  @@index([recipientTIN])
  @@index([taxYear])
  @@index([status])
  @@map("tax_form_1099")
}

model W9Information {
  id                  String            @id @default(cuid())
  userId              String
  businessName        String
  individualName      String?
  taxClassification   TaxClassification
  otherClassification String?
  exemptPayeeCode     String?
  fatcaExemptCode     String?
  address             String
  city                String
  state               String
  zip                 String
  tinType             TINType
  tin                 String
  certifiedDate       DateTime?
  signature           String?
  isCertified         Boolean           @default(false)
  requestedDate       DateTime          @default(now())
  submittedDate       DateTime?
  status              W9Status          @default(PENDING)
  vendorId            String?
  employeeId          String?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  @@index([userId])
  @@index([vendorId])
  @@index([status])
  @@map("w9_information")
}

model TaxForm1096 {
  id                 String    @id @default(cuid())
  userId             String
  taxYear            Int
  formType           String
  totalForms         Int
  totalAmount        Float
  payerName          String
  payerEIN           String
  payerAddress       String
  payerCity          String
  payerState         String
  payerZip           String
  contactName        String
  contactPhone       String
  contactEmail       String
  filedDate          DateTime?
  filedWithIRS       Boolean   @default(false)
  confirmationNumber String?
  form1099Ids        String[]
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  @@index([userId])
  @@index([taxYear])
  @@map("tax_form_1096")
}

model SalesTaxFiling {
  id                 String          @id @default(cuid())
  userId             String
  state              String
  county             String?
  city               String?
  jurisdiction       String
  filingPeriod       FilingPeriod
  periodStart        DateTime
  periodEnd          DateTime
  dueDate            DateTime
  grossSales         Float
  taxableSales       Float
  exemptSales        Float
  taxRate            Float
  taxCollected       Float
  taxDue             Float
  deductions         Float           @default(0)
  credits            Float           @default(0)
  penalties          Float           @default(0)
  interest           Float           @default(0)
  netTaxDue          Float
  status             TaxFilingStatus @default(DRAFT)
  filedDate          DateTime?
  paidDate           DateTime?
  confirmationNumber String?
  returnFileUrl      String?
  paymentProof       String?
  hasNexus           Boolean         @default(true)
  nexusType          NexusType?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  @@index([userId])
  @@index([state])
  @@index([periodStart])
  @@index([dueDate])
  @@index([status])
  @@map("sales_tax_filing")
}

model TaxDeadline {
  id                String            @id @default(cuid())
  userId            String
  taxType           TaxDeadlineType
  formName          String
  description       String
  jurisdiction      String
  isMultiState      Boolean           @default(false)
  states            String[]
  dueDate           DateTime
  extensionDate     DateTime?
  filingPeriod      String
  frequency         DeadlineFrequency
  isRecurring       Boolean           @default(true)
  status            DeadlineStatus    @default(UPCOMING)
  completedDate     DateTime?
  penaltyAmount     Float?
  penaltyRate       Float?
  interestRate      Float?
  reminderDays      Int[]
  notificationsSent Int               @default(0)
  lastNotification  DateTime?
  relatedFilingId   String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([userId])
  @@index([dueDate])
  @@index([status])
  @@index([taxType])
  @@map("tax_deadlines")
}

model SalesTaxNexus {
  id                      String        @id @default(cuid())
  userId                  String
  state                   String
  stateName               String
  economicThreshold       Float
  transactionThreshold    Int?
  currentYearSales        Float         @default(0)
  currentYearTransactions Int           @default(0)
  lastYearSales           Float         @default(0)
  lastYearTransactions    Int           @default(0)
  hasNexus                Boolean       @default(false)
  nexusType               NexusType?
  nexusDate               DateTime?
  isRegistered            Boolean       @default(false)
  registrationDate        DateTime?
  taxId                   String?
  certificateUrl          String?
  filingFrequency         FilingPeriod?
  nextFilingDate          DateTime?
  createdAt               DateTime      @default(now())
  updatedAt               DateTime      @updatedAt

  @@unique([userId, state])
  @@index([userId])
  @@index([hasNexus])
  @@map("sales_tax_nexus")
}

model Company {
  id                   String              @id @default(cuid())
  name                 String
  legalName            String?
  taxId                String?
  industry             String?
  website              String?
  logo                 String?
  address              String?
  city                 String?
  state                String?
  zipCode              String?
  country              String              @default("US")
  phone                String?
  email                String?
  settings             Json?
  subscription         SubscriptionTier    @default(FREE)
  isActive             Boolean             @default(true)
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  aiModels             AIModel[]
  anomalyDetections    AnomalyDetection[]
  apiKeys              ApiKey[]
  backupJobs           BackupJob[]
  chatConversations    ChatConversation[]
  invitations          CompanyInvitation[]
  roles                CompanyRole[]
  users                CompanyUser[]
  dashboards           Dashboard[]
  dataExports          DataExport[]
  dataImports          DataImport[]
  integrations         Integration[]
  kpis                 KPI[]
  predictionLogs       PredictionLog[]
  recommendations      Recommendation[]
  systemLogs           SystemLog[]
  trainingData         TrainingData[]
  webhooks             Webhook[]
  whiteLabel           WhiteLabel?
  uploadedDocuments    UploadedDocument[]
  categorizationRules  AiCategorizationRule[]
  firmClients          FirmClient[]
  journalEntries       JournalEntry[]
  invoices             Invoice[]
  expenses             Expense[]
  
  // New relations for full functionality
  bankRules            BankRule[]
  importJobs           ImportJob[]
  transactionAttachments TransactionAttachment[]
  invoiceTemplates     InvoiceTemplate[]
  reportGroups         ReportGroup[]
  savedReports         SavedReport[]
  transactionClasses   TransactionClass[]
  transactionLocations TransactionLocation[]
  paymentLinks         PaymentLink[]
  batchOperations      BatchOperation[]
  tparsReports         TPARSReport[]

  @@map("companies")
}

model CompanyUser {
  id           String      @id @default(cuid())
  companyId    String
  userId       String
  roleId       String
  isOwner      Boolean     @default(false)
  permissions  Json?
  invitedBy    String?
  invitedAt    DateTime?
  joinedAt     DateTime    @default(now())
  lastAccessAt DateTime?
  isActive     Boolean     @default(true)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  company      Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  role         CompanyRole @relation("UserRole", fields: [roleId], references: [id])
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([companyId, userId])
  @@map("company_users")
}

model Webhook {
  id         String            @id @default(cuid())
  companyId  String
  url        String
  events     String[]
  secret     String
  isActive   Boolean           @default(true)
  retryCount Int               @default(3)
  timeout    Int               @default(30)
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  deliveries WebhookDelivery[]
  logs       WebhookLog[]
  company    Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("webhooks")
}

model WebhookLog {
  id          String    @id @default(cuid())
  webhookId   String
  event       String
  payload     Json
  statusCode  Int?
  response    String?
  error       String?
  attempts    Int       @default(1)
  deliveredAt DateTime?
  createdAt   DateTime  @default(now())
  webhook     Webhook   @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId, createdAt])
  @@map("webhook_logs")
}

model SystemLog {
  id         String   @id @default(cuid())
  companyId  String?
  userId     String?
  level      LogLevel
  category   String
  action     String
  resource   String?
  resourceId String?
  message    String
  metadata   Json?
  ipAddress  String?
  userAgent  String?
  duration   Int?
  createdAt  DateTime @default(now())
  company    Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, createdAt])
  @@index([level, createdAt])
  @@index([category, createdAt])
  @@map("system_logs")
}

model BackupJob {
  id              String       @id @default(cuid())
  companyId       String
  type            BackupType
  status          BackupStatus
  size            BigInt?
  recordCount     Int?
  storageLocation String?
  compression     String?
  encryption      Boolean      @default(true)
  startedAt       DateTime?
  completedAt     DateTime?
  error           String?
  metadata        Json?
  createdBy       String?
  createdAt       DateTime     @default(now())
  company         Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, createdAt])
  @@map("backup_jobs")
}

model Integration {
  id            String               @id @default(cuid())
  companyId     String
  provider      IntegrationProvider
  name          String?
  status        IntegrationStatus    @default(DISCONNECTED)
  accessToken   String?
  refreshToken  String?
  expiresAt     DateTime?
  scopes        String[]
  settings      Json?
  lastSyncAt    DateTime?
  lastError     String?
  syncFrequency String?
  isActive      Boolean              @default(true)
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  syncLogs      IntegrationSyncLog[]
  company       Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, provider])
  @@map("integrations")
}

model AIModel {
  id           String          @id @default(cuid())
  companyId    String?
  type         AIModelType
  name         String
  description  String?
  version      String          @default("1.0.0")
  status       AIModelStatus   @default(TRAINING)
  accuracy     Float?
  trainingData Int             @default(0)
  lastTrained  DateTime?
  modelData    Json?
  config       Json?
  createdBy    String?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  company      Company?        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  predictions  PredictionLog[]

  @@index([companyId, type])
  @@map("ai_models")
}

model PredictionLog {
  id              String               @id @default(cuid())
  modelId         String
  companyId       String
  userId          String?
  inputData       Json
  prediction      Json
  confidence      PredictionConfidence
  confidenceScore Float
  feedback        String?
  isCorrect       Boolean?
  processingTime  Int?
  metadata        Json?
  createdAt       DateTime             @default(now())
  company         Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  model           AIModel              @relation(fields: [modelId], references: [id], onDelete: Cascade)

  @@index([modelId, createdAt])
  @@index([companyId, createdAt])
  @@map("prediction_logs")
}

model TrainingData {
  id          String      @id @default(cuid())
  companyId   String
  modelType   AIModelType
  features    Json
  label       String
  weight      Float       @default(1.0)
  source      String?
  isValidated Boolean     @default(false)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, modelType])
  @@index([isValidated])
  @@map("training_data")
}

model AnomalyDetection {
  id            String          @id @default(cuid())
  companyId     String
  type          AnomalyType
  severity      AnomalySeverity
  resource      String
  resourceId    String
  title         String
  description   String
  detectedValue Json
  expectedValue Json?
  confidence    Float
  isResolved    Boolean         @default(false)
  resolvedBy    String?
  resolvedAt    DateTime?
  resolution    String?
  metadata      Json?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  company       Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, isResolved])
  @@index([severity, isResolved])
  @@index([createdAt])
  @@map("anomaly_detections")
}

model Recommendation {
  id              String               @id @default(cuid())
  companyId       String
  type            RecommendationType
  status          RecommendationStatus @default(PENDING)
  title           String
  description     String
  potentialSaving Decimal?             @db.Decimal(15, 2)
  estimatedImpact String?
  actionSteps     Json
  relatedResource String?
  relatedId       String?
  priority        Int                  @default(0)
  confidence      Float
  expiresAt       DateTime?
  implementedBy   String?
  implementedAt   DateTime?
  feedback        String?
  actualSaving    Decimal?             @db.Decimal(15, 2)
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  company         Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, status])
  @@index([type, status])
  @@index([priority])
  @@map("recommendations")
}

model ChatConversation {
  id            String        @id @default(cuid())
  companyId     String
  userId        String
  title         String?
  context       Json?
  isActive      Boolean       @default(true)
  lastMessageAt DateTime      @default(now())
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  company       Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  messages      ChatMessage[]

  @@index([companyId, userId])
  @@index([lastMessageAt])
  @@map("chat_conversations")
}

model ChatMessage {
  id             String           @id @default(cuid())
  conversationId String
  role           String
  content        String
  functionCall   Json?
  functionResult Json?
  tokens         Int?
  model          String?
  metadata       Json?
  createdAt      DateTime         @default(now())
  conversation   ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@map("chat_messages")
}

model CompanyRole {
  id          String        @id @default(cuid())
  companyId   String
  name        String
  description String?
  permissions Json
  isSystem    Boolean       @default(false)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  company     Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  members     CompanyUser[] @relation("UserRole")

  @@unique([companyId, name])
  @@map("company_roles")
}

model CompanyInvitation {
  id         String           @id @default(cuid())
  companyId  String
  email      String
  roleId     String
  invitedBy  String
  token      String           @unique
  status     InvitationStatus @default(PENDING)
  expiresAt  DateTime
  acceptedAt DateTime?
  createdAt  DateTime         @default(now())
  company    Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([email, status])
  @@map("company_invitations")
}

model DataExport {
  id          String       @id @default(cuid())
  companyId   String
  userId      String
  type        ExportType
  format      ExportFormat
  filters     Json?
  status      JobStatus    @default(PENDING)
  fileUrl     String?
  fileSize    Int?
  recordCount Int?
  error       String?
  startedAt   DateTime?
  completedAt DateTime?
  expiresAt   DateTime?
  createdAt   DateTime     @default(now())
  company     Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, status])
  @@index([userId, createdAt])
  @@map("data_exports")
}

model DataImport {
  id            String       @id @default(cuid())
  companyId     String
  userId        String
  source        ImportSource
  fileUrl       String
  fileSize      Int
  status        JobStatus    @default(PENDING)
  mapping       Json?
  preview       Json?
  recordCount   Int?
  importedCount Int?
  errorCount    Int?
  errors        Json?
  startedAt     DateTime?
  completedAt   DateTime?
  createdAt     DateTime     @default(now())
  company       Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, status])
  @@index([userId, createdAt])
  @@map("data_imports")
}

model IntegrationSyncLog {
  id            String        @id @default(cuid())
  integrationId String
  direction     SyncDirection
  recordType    String
  recordCount   Int
  successCount  Int
  errorCount    Int
  errors        Json?
  duration      Int
  startedAt     DateTime
  completedAt   DateTime
  integration   Integration   @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@index([integrationId, startedAt])
  @@map("integration_sync_logs")
}

model WebhookDelivery {
  id         String    @id @default(cuid())
  webhookId  String
  event      String
  payload    Json
  response   Json?
  statusCode Int?
  success    Boolean
  attempts   Int       @default(1)
  nextRetry  DateTime?
  createdAt  DateTime  @default(now())
  webhook    Webhook   @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId, createdAt])
  @@index([success, nextRetry])
  @@map("webhook_deliveries")
}

model Dashboard {
  id          String   @id @default(cuid())
  companyId   String
  userId      String?
  name        String
  description String?
  layout      Json
  widgets     Json
  isPublic    Boolean  @default(false)
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, userId])
  @@map("dashboards")
}

model KPI {
  id           String    @id @default(cuid())
  companyId    String
  name         String
  metric       String
  target       Float?
  current      Float
  previous     Float?
  change       Float?
  trend        String?
  period       KPIPeriod
  calculatedAt DateTime  @default(now())
  company      Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, metric, period])
  @@index([calculatedAt])
  @@map("kpis")
}

model WhiteLabel {
  id           String   @id @default(cuid())
  companyId    String   @unique
  brandName    String
  logo         String?
  primaryColor String   @default("#3b82f6")
  accentColor  String   @default("#8b5cf6")
  customDomain String?  @unique
  emailFrom    String?
  emailFooter  String?
  favicon      String?
  loginImage   String?
  customCss    String?
  customJs     String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  company      Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("white_labels")
}

model ApiLog {
  id           String   @id @default(cuid())
  apiKeyId     String
  method       String
  endpoint     String
  statusCode   Int
  duration     Int
  ip           String?
  userAgent    String?
  requestBody  Json?
  responseBody Json?
  timestamp    DateTime @default(now())
  apiKey       ApiKey   @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)

  @@index([apiKeyId, timestamp])
  @@index([timestamp])
  @@map("api_logs")
}

enum UserRole {
  USER
  ADMIN
  ACCOUNTANT
}

enum CustomerStatus {
  ACTIVE
  INACTIVE
}

enum VendorStatus {
  ACTIVE
  INACTIVE
  BLOCKED
}

enum ProductType {
  PRODUCT
  SERVICE
}

enum ProductStatus {
  ACTIVE
  INACTIVE
}

enum InvoiceStatus {
  DRAFT
  SENT
  VIEWED
  PARTIAL
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentMethod {
  CASH
  TRANSFER
  CARD
  CHECK
  OTHER
}

enum ExpenseType {
  OPERATING
  ADMINISTRATIVE
  SALES
  FINANCIAL
  OTHER
}

enum ExpenseStatus {
  PENDING
  APPROVED
  REJECTED
  PAID
}

enum TransactionType {
  INCOME
  EXPENSE
  RECEIVABLE
  PAYABLE
}

enum TransactionStatus {
  PENDING
  COMPLETED
  CANCELLED
}

enum PayableStatus {
  UNPAID
  PARTIAL
  PAID
  OVERDUE
}

enum SalaryType {
  HOURLY
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
  YEARLY
}

enum EmployeeStatus {
  ACTIVE
  INACTIVE
  TERMINATED
}

enum PayrollStatus {
  DRAFT
  APPROVED
  PAID
  CANCELLED
}

enum TaxType {
  VAT
  INCOME
  ISR
  IVA
  RETENTION
  OTHER
}

enum TaxStatus {
  PENDING
  FILED
  PAID
  OVERDUE
}

enum BankAccountType {
  CHECKING
  SAVINGS
  CREDIT
  INVESTMENT
  CREDIT_CARD
  MONEY_MARKET
  LOAN
  OTHER
}

enum BankAccountStatus {
  ACTIVE
  INACTIVE
  CLOSED
  PENDING
  REQUIRES_UPDATE
  ERROR
}

enum ReconciliationStatus {
  IN_PROGRESS
  COMPLETED
  REVIEWED
  LOCKED
  REOPENED
}

enum MatchType {
  AUTOMATIC
  MANUAL
  SUGGESTED
  EXACT
  FUZZY
  RULE_BASED
}

enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  EXPENSE
}

enum AccountCategory {
  CURRENT_ASSET
  FIXED_ASSET
  CURRENT_LIABILITY
  LONG_TERM_LIABILITY
  EQUITY
  OPERATING_REVENUE
  NON_OPERATING_REVENUE
  OPERATING_EXPENSE
  NON_OPERATING_EXPENSE
  COST_OF_GOODS_SOLD
}

enum JournalEntryStatus {
  DRAFT
  POSTED
  APPROVED
  REVERSED
}

enum BudgetStatus {
  DRAFT
  ACTIVE
  CLOSED
  EXCEEDED
}

enum AssetCategory {
  LAND
  BUILDING
  MACHINERY
  VEHICLE
  FURNITURE
  COMPUTER
  SOFTWARE
  OTHER
}

enum DepreciationMethod {
  STRAIGHT_LINE
  DECLINING_BALANCE
  SUM_OF_YEARS
  UNITS_OF_PRODUCTION
}

enum AssetStatus {
  ACTIVE
  DISPOSED
  UNDER_MAINTENANCE
  RETIRED
}

enum TaxReturnStatus {
  DRAFT
  FILED
  PAID
  OVERDUE
}

enum ValuationMethod {
  FIFO
  LIFO
  AVERAGE
  SPECIFIC_IDENTIFICATION
}

enum AdjustmentType {
  SHRINKAGE
  DAMAGE
  OBSOLESCENCE
  COUNT_ADJUSTMENT
  TRANSFER
}

enum ReminderStatus {
  PENDING
  SENT
  PAID
  CANCELLED
}

enum StatementType {
  BALANCE_SHEET
  INCOME_STATEMENT
  CASH_FLOW
  TRIAL_BALANCE
  GENERAL_LEDGER
}

enum EInvoiceStatus {
  DRAFT
  SENT
  VIEWED
  PARTIALLY_PAID
  PAID
  OVERDUE
  VOID
  CANCELLED
}

enum ItemType {
  PRODUCT
  RAW_MATERIAL
  COMPONENT
  SERVICE
  BUNDLE
}

enum CostMethod {
  FIFO
  LIFO
  AVERAGE
  SPECIFIC
}

enum SerialStatus {
  IN_STOCK
  SOLD
  RETURNED
  DAMAGED
  LOST
}

enum MovementType {
  PURCHASE
  SALE
  ADJUSTMENT
  TRANSFER
  RETURN
  DAMAGE
  MANUFACTURING
}

enum POStatus {
  DRAFT
  SENT
  CONFIRMED
  PARTIAL
  RECEIVED
  CANCELLED
}

enum AlertType {
  LOW_STOCK
  OUT_OF_STOCK
  EXPIRING
  EXPIRED
  OVERSTOCK
}

enum Form1099Type {
  NEC
  MISC
  INT
  DIV
  B
  K
}

enum Tax1099Status {
  DRAFT
  READY
  SENT
  FILED
  CORRECTED
  VOID
}

enum TaxClassification {
  INDIVIDUAL
  C_CORPORATION
  S_CORPORATION
  PARTNERSHIP
  TRUST_ESTATE
  LLC_C
  LLC_S
  LLC_PARTNERSHIP
  OTHER
}

enum TINType {
  SSN
  EIN
}

enum W9Status {
  PENDING
  SUBMITTED
  VERIFIED
  EXPIRED
  REJECTED
}

enum FilingPeriod {
  MONTHLY
  QUARTERLY
  ANNUALLY
  SEMI_ANNUALLY
}

enum TaxFilingStatus {
  DRAFT
  READY
  FILED
  PAID
  LATE
  AMENDED
}

enum NexusType {
  PHYSICAL
  ECONOMIC
  CLICK_THROUGH
  MARKETPLACE
}

enum TaxDeadlineType {
  FEDERAL_INCOME_TAX
  STATE_INCOME_TAX
  SALES_TAX
  PAYROLL_TAX
  FORM_1099
  FORM_W2
  FORM_941
  FORM_940
  FORM_1096
  ANNUAL_REPORT
  FRANCHISE_TAX
  ESTIMATED_TAX
}

enum DeadlineFrequency {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  SEMI_ANNUALLY
  ANNUALLY
  ONE_TIME
}

enum DeadlineStatus {
  UPCOMING
  DUE_SOON
  OVERDUE
  COMPLETED
  EXTENDED
  WAIVED
}

enum SubscriptionTier {
  FREE
  BASIC
  PROFESSIONAL
  ENTERPRISE
  STARTER
  CUSTOM
}

enum PermissionAction {
  CREATE
  READ
  UPDATE
  DELETE
  APPROVE
  EXPORT
  IMPORT
  MANAGE
}

enum ApiEnvironment {
  DEVELOPMENT
  STAGING
  PRODUCTION
}

enum LogLevel {
  DEBUG
  INFO
  WARNING
  ERROR
  CRITICAL
}

enum BackupType {
  FULL
  INCREMENTAL
  DIFFERENTIAL
  MANUAL
  SCHEDULED
}

enum BackupStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  CANCELLED
}

enum IntegrationProvider {
  STRIPE
  QUICKBOOKS
  XERO
  PLAID
  SHOPIFY
  SALESFORCE
  MAILCHIMP
  SLACK
  ZAPIER
  CUSTOM
}

enum IntegrationStatus {
  CONNECTED
  DISCONNECTED
  ERROR
  PENDING_AUTH
  EXPIRED
}

enum AIModelType {
  EXPENSE_CATEGORIZATION
  INVOICE_OCR
  CASH_FLOW_FORECASTING
  ANOMALY_DETECTION
  RECOMMENDATION_ENGINE
  CHATBOT
}

enum AIModelStatus {
  TRAINING
  READY
  DEPLOYED
  DEPRECATED
  FAILED
}

enum PredictionConfidence {
  LOW
  MEDIUM
  HIGH
  VERY_HIGH
}

enum AnomalyType {
  DUPLICATE_TRANSACTION
  UNUSUAL_AMOUNT
  SUSPICIOUS_VENDOR
  SPENDING_SPIKE
  FRAUD_PATTERN
  MISSING_RECEIPT
  LATE_PAYMENT
  BUDGET_OVERRUN
}

enum AnomalySeverity {
  INFO
  WARNING
  CRITICAL
  URGENT
}

enum RecommendationType {
  TAX_SAVING
  COST_REDUCTION
  PAYMENT_TERMS
  AUTOMATION
  WORKFLOW_IMPROVEMENT
  VENDOR_NEGOTIATION
  EARLY_PAYMENT_DISCOUNT
  INVENTORY_OPTIMIZATION
}

enum RecommendationStatus {
  PENDING
  ACCEPTED
  REJECTED
  IMPLEMENTED
  EXPIRED
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

enum ExportType {
  FULL_BACKUP
  INVOICES
  EXPENSES
  CUSTOMERS
  PRODUCTS
  REPORTS
  AUDIT_TRAIL
  TAX_DOCUMENTS
}

enum ExportFormat {
  CSV
  EXCEL
  PDF
  JSON
  QUICKBOOKS_IIF
  XERO_CSV
  XML
}

enum ImportSource {
  CSV
  EXCEL
  QUICKBOOKS_DESKTOP
  QUICKBOOKS_ONLINE
  XERO
  FRESHBOOKS
  WAVE
  CUSTOM
}

enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum SyncDirection {
  IMPORT
  EXPORT
  BIDIRECTIONAL
}

enum KPIPeriod {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

model CorporateCard {
  id                String                  @id @default(cuid())
  userId            String
  companyId         String?
  cardNumber        String                  @unique
  lastFourDigits    String
  cardHolderName    String
  cardType          CorporateCardType       @default(CREDIT)
  cardBrand         String
  expiryMonth       Int
  expiryYear        Int
  creditLimit       Float?
  currentBalance    Float                   @default(0)
  availableCredit   Float?
  billingCycle      Int                     @default(1)
  status            CorporateCardStatus     @default(ACTIVE)
  isVirtual         Boolean                 @default(false)
  department        String?
  notes             String?
  lastSyncedAt      DateTime?
  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt
  transactions      CorporateCardTransaction[]
  rules             CorporateCardRule[]

  @@map("corporate_cards")
}

model CorporateCardTransaction {
  id                String                      @id @default(cuid())
  cardId            String
  expenseId         String?
  merchantName      String
  merchantCategory  String?
  amount            Float
  currency          String                      @default("MXN")
  transactionDate   DateTime
  postingDate       DateTime?
  description       String
  transactionType   CardTransactionType         @default(PURCHASE)
  status            CardTransactionStatus       @default(PENDING)
  isReconciled      Boolean                     @default(false)
  reconciledAt      DateTime?
  categoryId        String?
  notes             String?
  receiptUrl        String?
  metadata          Json?
  createdAt         DateTime                    @default(now())
  updatedAt         DateTime                    @updatedAt
  card              CorporateCard               @relation(fields: [cardId], references: [id], onDelete: Cascade)

  @@map("corporate_card_transactions")
}

model CorporateCardRule {
  id                String                  @id @default(cuid())
  cardId            String?
  companyId         String?
  name              String
  description       String?
  merchantPattern   String?
  amountMin         Float?
  amountMax         Float?
  categoryId        String?
  autoReconcile     Boolean                 @default(false)
  requireReceipt    Boolean                 @default(false)
  notifyOnMatch     Boolean                 @default(false)
  isActive          Boolean                 @default(true)
  priority          Int                     @default(0)
  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt
  card              CorporateCard?          @relation(fields: [cardId], references: [id], onDelete: Cascade)

  @@map("corporate_card_rules")
}

enum CorporateCardType {
  CREDIT
  DEBIT
  PREPAID
}

enum CorporateCardStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  EXPIRED
  CANCELLED
}

enum CardTransactionType {
  PURCHASE
  REFUND
  PAYMENT
  FEE
  INTEREST
  CASH_ADVANCE
}

enum CardTransactionStatus {
  PENDING
  POSTED
  DECLINED
  CANCELLED
  REFUNDED
}

// ==================== PAYROLL EXTENDED MODELS ====================

model TimeEntry {
  id          String          @id @default(cuid())
  employeeId  String
  projectId   String?
  date        DateTime
  clockIn     DateTime
  clockOut    DateTime?
  breakMinutes Int            @default(0)
  hoursWorked Float?
  overtime    Float           @default(0)
  notes       String?
  status      TimeEntryStatus @default(PENDING)
  approvedBy  String?
  approvedAt  DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  employee    Employee        @relation(fields: [employeeId], references: [id])
  project     Project?        @relation(fields: [projectId], references: [id])

  @@map("time_entries")
}

model PayrollCheck {
  id            String      @id @default(cuid())
  payrollId     String?
  employeeId    String
  checkNumber   String      @unique
  amount        Float
  checkDate     DateTime
  memo          String?
  bankAccount   String?
  status        CheckStatus @default(PENDING)
  printedAt     DateTime?
  voidedAt      DateTime?
  voidReason    String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  employee      Employee    @relation(fields: [employeeId], references: [id])
  payroll       Payroll?    @relation(fields: [payrollId], references: [id])

  @@map("payroll_checks")
}

model PayrollPayment {
  id            String        @id @default(cuid())
  payrollId     String?
  employeeId    String
  amount        Float
  paymentType   PaymentType
  paymentDate   DateTime
  reference     String?
  bankAccount   String?
  status        PaymentStatus @default(PENDING)
  processedAt   DateTime?
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  employee      Employee      @relation(fields: [employeeId], references: [id])
  payroll       Payroll?      @relation(fields: [payrollId], references: [id])

  @@map("payroll_payments")
}

model PayrollRun {
  id            String          @id @default(cuid())
  runNumber     String          @unique
  periodType    String          @default("MONTHLY")
  periodStart   DateTime
  periodEnd     DateTime
  payDate       DateTime
  totalGross    Float           @default(0)
  totalDeductions Float         @default(0)
  totalNet      Float           @default(0)
  employeeCount Int             @default(0)
  status        PayrollRunStatus @default(DRAFT)
  notes         String?
  calculatedAt  DateTime?
  approvedBy    String?
  approvedAt    DateTime?
  processedAt   DateTime?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  userId        String
  items         PayrollRunItem[]

  @@map("payroll_runs")
}

model PayrollRunItem {
  id            String     @id @default(cuid())
  runId         String
  employeeId    String
  grossSalary   Float
  regularHours  Float      @default(0)
  overtimeHours Float      @default(0)
  deductions    Float      @default(0)
  bonuses       Float      @default(0)
  netSalary     Float
  status        String     @default("PENDING")
  run           PayrollRun @relation(fields: [runId], references: [id], onDelete: Cascade)
  employee      Employee   @relation(fields: [employeeId], references: [id])

  @@map("payroll_run_items")
}

enum TimeEntryStatus {
  PENDING
  APPROVED
  REJECTED
}

enum CheckStatus {
  PENDING
  PRINTED
  ISSUED
  CASHED
  VOIDED
}

enum PaymentType {
  BANK_TRANSFER
  CASH
  CHECK
  DIRECT_DEPOSIT
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum PayrollRunStatus {
  DRAFT
  CALCULATED
  APPROVED
  PROCESSING
  COMPLETED
  CANCELLED
}

// ============================================
// DOCUMENT PROCESSING AI - Sistema Inteligente
// ============================================

enum DocumentStatus {
  PENDING
  PROCESSING
  ANALYZED
  APPROVED
  REJECTED
  ERROR
}

enum DocumentType {
  INVOICE
  RECEIPT
  BANK_STATEMENT
  TAX_DOCUMENT
  CONTRACT
  EXPENSE_REPORT
  PAYROLL
  OTHER
}

model UploadedDocument {
  id                  String         @id @default(cuid())
  filename            String
  originalName        String
  mimeType            String
  fileSize            Int
  filePath            String?
  fileUrl             String?
  documentType        DocumentType   @default(OTHER)
  status              DocumentStatus @default(PENDING)
  
  // Relaciones
  uploadedById        String
  uploadedBy          User           @relation(fields: [uploadedById], references: [id])
  companyId           String
  company             Company        @relation(fields: [companyId], references: [id])
  
  // OCR y AI
  ocrText             String?        @db.Text
  ocrConfidence       Float?
  aiAnalysis          Json?
  extractedData       Json?
  suggestedAccountId  String?
  suggestedAccount    ChartOfAccounts? @relation(fields: [suggestedAccountId], references: [id])
  suggestedCategory   String?
  aiConfidence        Float?
  processingTime      Int?           // en milisegundos
  
  // Datos extraídos
  journalEntryId      String?
  journalEntry        JournalEntry?  @relation(fields: [journalEntryId], references: [id])
  transactionId       String?
  expenseId           String?
  vendorId            String?
  vendor              Vendor?        @relation(fields: [vendorId], references: [id])
  customerId          String?
  amount              Float?
  documentDate        DateTime?
  dueDate             DateTime?
  invoiceNumber       String?
  description         String?
  notes               String?
  
  // Revisión
  reviewedById        String?
  reviewedAt          DateTime?
  approvedById        String?
  approvedAt          DateTime?
  errorMessage        String?
  metadata            Json?
  
  // Logs de procesamiento
  processingLogs      DocumentProcessingLog[]
  
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt

  @@index([companyId])
  @@index([status])
  @@index([documentType])
  @@index([uploadedById])
  @@index([createdAt])
  @@map("uploaded_documents")
}

model DocumentProcessingLog {
  id          String           @id @default(cuid())
  documentId  String
  document    UploadedDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  stage       String           // OCR, ANALYSIS, CATEGORIZATION, JOURNAL_ENTRY, etc.
  status      String           // SUCCESS, ERROR, WARNING
  message     String?
  details     Json?
  duration    Int?             // en milisegundos
  createdAt   DateTime         @default(now())

  @@index([documentId])
  @@map("document_processing_logs")
}

model AiCategorizationRule {
  id                 String          @id @default(cuid())
  companyId          String
  company            Company         @relation(fields: [companyId], references: [id])
  vendorPattern      String?         // Regex pattern para vendor
  descriptionPattern String?         // Regex pattern para descripción
  amountMin          Float?
  amountMax          Float?
  accountId          String
  account            ChartOfAccounts @relation(fields: [accountId], references: [id])
  category           String?
  priority           Int             @default(0)
  isActive           Boolean         @default(true)
  timesUsed          Int             @default(0)
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  @@index([companyId])
  @@map("ai_categorization_rules")
}

// ============================================
// ACCOUNTING FIRM MANAGEMENT MODELS
// ============================================

model AccountingFirm {
  id                  String            @id @default(cuid())
  name                String
  legalName           String?
  taxId               String?
  licenseNumber       String?           // CPA License, etc.
  address             String?
  city                String?
  state               String?
  zipCode             String?
  country             String            @default("US")
  phone               String?
  email               String?
  website             String?
  logo                String?
  settings            Json?             // Firm-specific settings
  subscription        FirmSubscription  @default(PROFESSIONAL)
  maxClients          Int               @default(50)
  isActive            Boolean           @default(true)
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  
  clients             FirmClient[]
  staff               FirmStaff[]
  engagements         ClientEngagement[]
  timeEntries         FirmTimeEntry[]
  
  @@map("accounting_firms")
}

model FirmStaff {
  id              String           @id @default(cuid())
  firmId          String
  userId          String
  role            StaffRole        @default(STAFF)
  title           String?
  department      String?
  hourlyRate      Float?
  billableRate    Float?
  targetHours     Float?           // Monthly billable target
  isActive        Boolean          @default(true)
  startDate       DateTime         @default(now())
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  firm            AccountingFirm   @relation(fields: [firmId], references: [id], onDelete: Cascade)
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  assignedClients FirmClient[]     @relation("PrimaryAccountant")
  secondaryClients FirmClient[]    @relation("SecondaryAccountant")
  timeEntries     FirmTimeEntry[]
  
  @@unique([firmId, userId])
  @@map("firm_staff")
}

model FirmClient {
  id                    String              @id @default(cuid())
  firmId                String
  companyId             String
  clientCode            String              // Client reference number
  status                ClientStatus        @default(ACTIVE)
  engagementType        EngagementType      @default(MONTHLY)
  primaryAccountantId   String?
  secondaryAccountantId String?
  monthlyFee            Float?
  hourlyRate            Float?
  retainerHours         Float?
  billingType           BillingType         @default(FIXED)
  contractStartDate     DateTime?
  contractEndDate       DateTime?
  taxFilingDeadlines    Json?               // { Q1: date, Q2: date, ... }
  notes                 String?
  priority              ClientPriority      @default(NORMAL)
  lastReviewDate        DateTime?
  nextReviewDate        DateTime?
  healthScore           Int?                // 0-100
  alertsEnabled         Boolean             @default(true)
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  
  firm                  AccountingFirm      @relation(fields: [firmId], references: [id], onDelete: Cascade)
  company               Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  primaryAccountant     FirmStaff?          @relation("PrimaryAccountant", fields: [primaryAccountantId], references: [id])
  secondaryAccountant   FirmStaff?          @relation("SecondaryAccountant", fields: [secondaryAccountantId], references: [id])
  engagements           ClientEngagement[]
  timeEntries           FirmTimeEntry[]
  alerts                ClientAlert[]
  documents             ClientDocument[]
  
  @@unique([firmId, companyId])
  @@unique([firmId, clientCode])
  @@index([status])
  @@index([primaryAccountantId])
  @@map("firm_clients")
}

model ClientEngagement {
  id              String           @id @default(cuid())
  firmId          String
  clientId        String
  type            EngagementType
  name            String
  description     String?
  status          EngagementStatus @default(ACTIVE)
  startDate       DateTime
  endDate         DateTime?
  deadline        DateTime?
  estimatedHours  Float?
  actualHours     Float?           @default(0)
  budgetAmount    Float?
  billedAmount    Float?           @default(0)
  progress        Int?             @default(0) // 0-100
  priority        ClientPriority   @default(NORMAL)
  assignedStaff   Json?            // Array of staff IDs
  notes           String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  firm            AccountingFirm   @relation(fields: [firmId], references: [id], onDelete: Cascade)
  client          FirmClient       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  timeEntries     FirmTimeEntry[]
  tasks           EngagementTask[]
  
  @@index([clientId, status])
  @@index([deadline])
  @@map("client_engagements")
}

model EngagementTask {
  id            String            @id @default(cuid())
  engagementId  String
  name          String
  description   String?
  status        TaskStatus        @default(TODO)
  priority      Int               @default(0)
  assignedTo    String?
  dueDate       DateTime?
  completedAt   DateTime?
  estimatedTime Float?
  actualTime    Float?
  sortOrder     Int               @default(0)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  
  engagement    ClientEngagement  @relation(fields: [engagementId], references: [id], onDelete: Cascade)
  
  @@index([engagementId, status])
  @@map("engagement_tasks")
}

model FirmTimeEntry {
  id            String              @id @default(cuid())
  firmId        String
  staffId       String
  clientId      String?
  engagementId  String?
  date          DateTime
  hours         Float
  description   String?
  isBillable    Boolean             @default(true)
  billableRate  Float?
  isBilled      Boolean             @default(false)
  billedDate    DateTime?
  invoiceId     String?
  status        FirmTimeEntryStatus @default(DRAFT)
  approvedBy    String?
  approvedAt    DateTime?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  
  firm          AccountingFirm      @relation(fields: [firmId], references: [id], onDelete: Cascade)
  staff         FirmStaff           @relation(fields: [staffId], references: [id], onDelete: Cascade)
  client        FirmClient?         @relation(fields: [clientId], references: [id], onDelete: SetNull)
  engagement    ClientEngagement?   @relation(fields: [engagementId], references: [id], onDelete: SetNull)
  
  @@index([staffId, date])
  @@index([clientId, date])
  @@index([isBilled])
  @@map("firm_time_entries")
}

model ClientAlert {
  id            String            @id @default(cuid())
  clientId      String
  type          ClientAlertType
  severity      ClientAlertSeverity @default(INFO)
  title         String
  message       String
  data          Json?
  deadline      DateTime?
  isRead        Boolean           @default(false)
  isResolved    Boolean           @default(false)
  resolvedAt    DateTime?
  resolvedBy    String?
  createdAt     DateTime          @default(now())
  
  client        FirmClient        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  @@index([clientId, isResolved])
  @@index([type, severity])
  @@map("client_alerts")
}

model ClientDocument {
  id            String              @id @default(cuid())
  clientId      String
  name          String
  type          ClientDocumentType
  category      String?
  fileUrl       String
  fileSize      Int?
  mimeType      String?
  year          Int?
  period        String?             // Q1, Q2, Monthly, etc.
  uploadedBy    String?
  notes         String?
  tags          String[]            @default([])
  isArchived    Boolean             @default(false)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  
  client        FirmClient          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  @@index([clientId, type])
  @@index([year])
  @@map("client_documents")
}

// Enums for Accounting Firm

enum FirmSubscription {
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum StaffRole {
  OWNER
  PARTNER
  MANAGER
  SENIOR
  STAFF
  INTERN
}

enum ClientStatus {
  PROSPECT
  ONBOARDING
  ACTIVE
  INACTIVE
  CHURNED
}

enum EngagementType {
  MONTHLY
  QUARTERLY
  ANNUAL
  TAX_RETURN
  AUDIT
  ADVISORY
  PAYROLL
  BOOKKEEPING
  CONSULTATION
  PROJECT
}

enum EngagementStatus {
  DRAFT
  ACTIVE
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum BillingType {
  FIXED
  HOURLY
  RETAINER
  VALUE_BASED
}

enum ClientPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  REVIEW
  BLOCKED
  COMPLETED
}

enum FirmTimeEntryStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
}

enum ClientAlertType {
  TAX_DEADLINE
  RECONCILIATION_DUE
  DOCUMENT_MISSING
  BALANCE_ANOMALY
  REVIEW_DUE
  CONTRACT_EXPIRING
  PAYMENT_OVERDUE
  CUSTOM
}

enum ClientAlertSeverity {
  INFO
  WARNING
  CRITICAL
}

enum ClientDocumentType {
  TAX_RETURN
  FINANCIAL_STATEMENT
  BANK_STATEMENT
  RECEIPT
  CONTRACT
  CORRESPONDENCE
  WORKING_PAPER
  OTHER
}

// ============================================
// NEW MODELS FOR FULL FUNCTIONALITY
// ============================================

// Bank Rules for automatic transaction categorization
model BankRule {
  id              String       @id @default(cuid())
  companyId       String
  name            String
  description     String?
  priority        Int          @default(0)
  isActive        Boolean      @default(true)
  
  // Conditions (all must match)
  conditionField  String       // description, amount, payee
  conditionType   String       // contains, equals, starts_with, ends_with, greater_than, less_than
  conditionValue  String
  
  // Actions
  actionType      String       // categorize, split, tag, rename
  categoryId      String?      // For categorize action
  accountId       String?      // Chart of accounts ID
  taxCode         String?
  memo            String?
  tags            String[]     @default([])
  
  matchCount      Int          @default(0)
  lastMatchedAt   DateTime?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  company         Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  @@index([companyId])
  @@map("bank_rules")
}

// Import jobs for tracking CSV/Excel imports
model ImportJob {
  id              String       @id @default(cuid())
  companyId       String
  userId          String
  type            ImportType   // CUSTOMERS, VENDORS, PRODUCTS, TRANSACTIONS, CHART_OF_ACCOUNTS
  fileName        String
  fileSize        Int
  status          ImportStatus @default(PENDING)
  
  totalRows       Int          @default(0)
  processedRows   Int          @default(0)
  successRows     Int          @default(0)
  errorRows       Int          @default(0)
  
  errors          Json?        // Array of error messages with row numbers
  mapping         Json?        // Column mapping configuration
  
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime     @default(now())
  
  company         Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  @@index([companyId])
  @@map("import_jobs")
}

// Transaction attachments
model TransactionAttachment {
  id              String       @id @default(cuid())
  companyId       String
  transactionType String       // expense, invoice, payment, bill, journal_entry
  transactionId   String       // ID of the related transaction
  
  fileName        String
  fileType        String       // pdf, jpg, png, etc
  fileSize        Int
  fileUrl         String
  thumbnailUrl    String?
  
  uploadedBy      String
  description     String?
  
  createdAt       DateTime     @default(now())
  
  company         Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  @@index([companyId, transactionType, transactionId])
  @@map("transaction_attachments")
}

// Invoice templates for customization
model InvoiceTemplate {
  id              String       @id @default(cuid())
  companyId       String
  name            String
  isDefault       Boolean      @default(false)
  
  // Header customization
  logoUrl         String?
  headerColor     String       @default("#2CA01C")
  accentColor     String       @default("#0077C5")
  fontFamily      String       @default("Inter")
  
  // Content sections
  showLogo        Boolean      @default(true)
  showCompanyAddress Boolean   @default(true)
  showCustomerAddress Boolean  @default(true)
  showDueDate     Boolean      @default(true)
  showPaymentTerms Boolean     @default(true)
  showNotes       Boolean      @default(true)
  showTaxBreakdown Boolean     @default(true)
  showPaymentInfo Boolean      @default(true)
  
  // Footer customization
  footerText      String?
  termsText       String?
  
  // Custom fields
  customFields    Json?        // Array of custom fields
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  company         Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  @@index([companyId])
  @@map("invoice_templates")
}

// Report groups for organizing reports
model ReportGroup {
  id              String       @id @default(cuid())
  companyId       String
  name            String
  description     String?
  color           String       @default("#0077C5")
  icon            String       @default("folder")
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  company         Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  reports         SavedReport[]
  
  @@index([companyId])
  @@map("report_groups")
}

// Saved/Custom reports
model SavedReport {
  id              String       @id @default(cuid())
  companyId       String
  groupId         String?
  
  name            String
  description     String?
  reportType      String       // profit_loss, balance_sheet, cash_flow, custom, etc
  
  // Report configuration
  filters         Json?        // Date range, accounts, etc
  columns         Json?        // Which columns to show
  groupBy         String?
  sortBy          String?
  
  // Scheduling
  isScheduled     Boolean      @default(false)
  scheduleFreq    String?      // daily, weekly, monthly
  scheduleDay     Int?
  scheduleTime    String?
  emailRecipients String[]     @default([])
  lastRunAt       DateTime?
  nextRunAt       DateTime?
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  company         Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  group           ReportGroup? @relation(fields: [groupId], references: [id])
  
  @@index([companyId])
  @@map("saved_reports")
}

// Class tracking for transactions
model TransactionClass {
  id              String       @id @default(cuid())
  companyId       String
  name            String
  description     String?
  parentId        String?
  isActive        Boolean      @default(true)
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  company         Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  parent          TransactionClass?  @relation("ClassHierarchy", fields: [parentId], references: [id])
  children        TransactionClass[] @relation("ClassHierarchy")
  
  @@unique([companyId, name])
  @@index([companyId])
  @@map("transaction_classes")
}

// Location tracking for transactions
model TransactionLocation {
  id              String       @id @default(cuid())
  companyId       String
  name            String
  address         String?
  city            String?
  state           String?
  country         String?
  isActive        Boolean      @default(true)
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  company         Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  @@unique([companyId, name])
  @@index([companyId])
  @@map("transaction_locations")
}

// Payment links for online payments
model PaymentLink {
  id              String       @id @default(cuid())
  companyId       String
  invoiceId       String?
  
  linkCode        String       @unique
  amount          Float
  currency        String       @default("USD")
  description     String?
  customerEmail   String?
  customerName    String?
  
  status          PaymentLinkStatus @default(ACTIVE)
  expiresAt       DateTime?
  
  // Payment info when paid
  paidAt          DateTime?
  paidAmount      Float?
  paymentMethod   String?
  stripePaymentId String?
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  company         Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  @@index([companyId])
  @@index([linkCode])
  @@map("payment_links")
}

// Batch operations tracking
model BatchOperation {
  id              String       @id @default(cuid())
  companyId       String
  userId          String
  type            BatchOperationType // CATEGORIZE, APPROVE, DELETE, EXPORT
  status          BatchStatus  @default(PENDING)
  
  totalItems      Int          @default(0)
  processedItems  Int          @default(0)
  successItems    Int          @default(0)
  errorItems      Int          @default(0)
  
  itemIds         String[]     @default([])
  actionData      Json?        // What action to perform
  results         Json?        // Results of each item
  
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime     @default(now())
  
  company         Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  @@index([companyId])
  @@map("batch_operations")
}

// TPARS (Taxable Payments Annual Report)
model TPARSReport {
  id              String       @id @default(cuid())
  companyId       String
  fiscalYear      Int
  status          TPARSStatus  @default(DRAFT)
  
  // Totals
  totalPayments   Float        @default(0)
  totalGST        Float        @default(0)
  totalWithheld   Float        @default(0)
  vendorCount     Int          @default(0)
  
  // Report data
  reportData      Json?        // Detailed vendor payments
  
  generatedAt     DateTime?
  submittedAt     DateTime?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  company         Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  @@unique([companyId, fiscalYear])
  @@index([companyId])
  @@map("tpars_reports")
}

// Enums for new models
enum ImportType {
  CUSTOMERS
  VENDORS
  PRODUCTS
  TRANSACTIONS
  CHART_OF_ACCOUNTS
  BANK_TRANSACTIONS
}

enum ImportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum PaymentLinkStatus {
  ACTIVE
  PAID
  EXPIRED
  CANCELLED
}

enum BatchOperationType {
  CATEGORIZE
  APPROVE
  DELETE
  EXPORT
  RECONCILE
}

enum BatchStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum TPARSStatus {
  DRAFT
  GENERATED
  REVIEWED
  SUBMITTED
  AMENDED
}
